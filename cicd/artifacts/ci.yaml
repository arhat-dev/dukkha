workflow:run:
# required by ci
- name: build-artifacts
  jobs:
  - task:
      ref: golang:build(dukkha)
      matrix_filter: {}

# required by ci
- name: sign-artifacts
  jobs:
  # generate dukkha.*.sig
  - task:
      ref@tpl: |-
        {{- if eq env.GITHUB_ACTIONS "true" -}}
          cosign:sign(dukkha)
        {{- else -}}
          cosign:sign(fake)
        {{- end -}}
      matrix_filter: {}

# upload signed artifacts to ghcr.io
# required by ci
- name: upload-artifacts
  jobs:
  - task:
      ref: docker:login(ghcr)
      matrix_filter: {}
  - task:
      ref: cosign:upload(dukkha)
      matrix_filter: {}

# required by ci
- name: create-release
  jobs:
  # generate dukkha.*.{sha256,sha512,md5}
  - task:
      ref: workflow:run(gen-artifacts-checksum)
      matrix_filter: {}
  # generate dukkha.*.{tar.gz,zip}
  # using dukkha.*.{,.exe,sha256,sha512,md5,sig} and license.txt
  - task:
      ref: archive:create(dukkha)
      matrix_filter: {}

  # generate checksums for archives
  - chdir: build
    shell: |-
      openssl dgst -sha256 *.tar* *.zip > sha256.txt
      openssl dgst -sha512 *.tar* *.zip > sha512.txt
      openssl dgst -md5 *.tar* *.zip > md5.txt

  # create github release
  - task:
      ref: |-
        {{- if eq env.GITHUB_ACTIONS "true" -}}
          github:release(dukkha)
        {{- else -}}
          github:release(fake)
        {{- end -}}
      matrix_filter: {}

    continue_on_error@tpl: |-
      {{- if eq env.GITHUB_ACTIONS "true" -}}
        false
      {{- else -}}
        true
      {{- end -}}

#
#
#

- name: gen-artifacts-checksum
  matrix@file: cicd/artifacts/matrix.yml
  jobs:
  - chdir: build
    shell@tpl: |-
      openssl dgst -sha256 {{ include "artifacts.bin-name" . }} \
        > dukkha.{{ matrix.kernel }}.{{ matrix.arch }}.sha256
      openssl dgst -sha512 {{ include "artifacts.bin-name" . }} \
        > dukkha.{{ matrix.kernel }}.{{ matrix.arch }}.sha512
      openssl dgst -md5 {{ include "artifacts.bin-name" . }} \
        > dukkha.{{ matrix.kernel }}.{{ matrix.arch }}.md5
