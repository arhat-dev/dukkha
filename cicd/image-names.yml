{{- $branch := (.Env.GIT_BRANCH | replace "/" "-" | kebabcase) }}

{{- $tag := "" -}}
{{- $manifest_tag := "" -}}

{{- if (eq .Env.GIT_WORKTREE_CLEAN "true") -}}
  {{- if .Env.GIT_TAG -}}

    {{- $tag = printf "%s-%s" .Env.GIT_TAG .Env.MATRIX_ARCH -}}
    {{- $manifest_tag = printf "%s" .Env.GIT_TAG -}}

  {{- else if (eq .Env.GIT_DEFAULT_BRANCH .Env.GIT_BRANCH) -}}

    {{- $tag = printf "%s-latest" .Env.MATRIX_ARCH -}}
    {{- $manifest_tag = "latest" -}}

  {{- else -}}

    {{- $tag = printf "%s-%s-%s" $branch .Env.GIT_COMMIT .Env.MATRIX_ARCH -}}
    {{- $manifest_tag = printf "%s-%s" $branch .Env.GIT_COMMIT }}

  {{- end -}}
{{- else -}}

  {{- $tag = printf "dev-%s-%s" $branch .Env.MATRIX_ARCH -}}
  {{- $manifest_tag = printf "dev-%s" $branch -}}

{{- end -}}

# - image: docker.io/arhatdev/dukkha:{{ $tag }}
#   manifest: docker.io/arhatdev/dukkha:{{ $manifest_tag }}
- image: ghcr.io/arhat-dev/dukkha:{{ $tag }}
  manifest: ghcr.io/arhat-dev/dukkha:{{ $manifest_tag }}
