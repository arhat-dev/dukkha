workflow:run:
# required by ci job
- name: test
  jobs:
  - task:
      ref: golang:test(dukkha)
      matrix_filter: {}
  # test shell PATH lookup
  # if any issue, fix it in https://github.com/arhat-dev/sh/tree/dukkha
  - name: test path lookup under cygwin
    if@tpl: |-
      {{- eq matrix.kernel "windows" -}}

    shell: |-
      set -x

      echo "PATH=${PATH}"

      command -v cygpath
      command -v dukkha

      make dukkha

      ./build/dukkha render <<EOF
      sh@shell: command -v dukkha
      tpl@tpl: |-
        {{- os.Lookup "dukkha" -}}
      EOF

  - name: test path lookup under wine64
    if@tpl: |-
      {{- ne matrix.kernel "windows" -}}
    shell: |-
      set -x

      make dukkha

      ./build/dukkha run golang local build dukkha -m kernel=windows -m arch=amd64

      wine64 ./build/dukkha.windows.amd64.exe render <<EOF
      sh@shell: command -v winepath
      tpl@tpl: |-
        {{- os.Lookup "winepath" -}}
      EOF

  - name: test path lookup under wine32
    # macos doesn't support running i386 wine
    if@tpl: |-
      {{- eq matrix.kernel "linux" -}}
    shell: |-
      set -x

      # already built ./build/dukkha in previous step

      ./build/dukkha run golang local build dukkha -m kernel=windows -m arch=x86

      wine ./build/dukkha.windows.x86.exe render <<EOF
      sh@shell: command -v winepath
      tpl@tpl: |-
        {{- os.Lookup "winepath" -}}
      EOF

- name: report
  matrix:
    tool:
    - sonar-scanner
  jobs:
  # only run sonar scan on linux and darwin during CI
  - cmd@presets?str|tpl#use-spec: tools/presets.tpl
    continue_on_error: true
