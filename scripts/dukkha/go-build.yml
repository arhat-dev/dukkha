- name: dukkha
  path: ./cmd/dukkha
  env:
  - name: CGO_CFLAGS_ALLOW
    value: -W
  hooks:
    before:matrix:
    - shell: echo "${MATRIX_KERNEL}/${MATRIX_ARCH}"
  cgo:
    enabled: false
    cc: gcc
    cxx: g++

    # cc@template: |-
    #   {{- if eq .Env.HOST_OS "debian" "ubuntu" -}}
    #     {{- getDebianTripleName .Env.MATRIX_ARCH -}}
    #   {{- else if eq .Env.HOST_OS "alpine" -}}
    #     {{- getAlpineTripleName .Env.MATRIX_ARCH -}}
    #   {{- get -}}
    #   -gcc

    # cc@template: |-
    #   {{- if eq .Env.HOST_OS "debian" "ubuntu" -}}
    #     {{- getDebianTripleName .Env.MATRIX_ARCH -}}
    #   {{- else if eq .Env.HOST_OS "alpine" -}}
    #     {{- getAlpineTripleName .Env.MATRIX_ARCH -}}
    #   {{- get -}}
    #   -g++

    cflags@shell: |-
      cat <<EOF >/dev/null
      - -I/usr/include/glib-2.0
      - -I/usr/include
      EOF

    ldflags@shell: |-
      cat <<EOF >/dev/null
      - -s -w
      EOF
  matrix@file: scripts/dukkha/build-matrix.yml
  tags:
  - nokube
  - nocloud
  - netgo
  - real
  ldflags@env:
  - -s -w
  - -X "arhat.dev/dukkha/pkg/version.branch=${GIT_BRANCH}"
  - -X "arhat.dev/dukkha/pkg/version.commit=${GIT_COMMIT}"
  - -X "arhat.dev/dukkha/pkg/version.tag=${GIT_TAG}"
  - -X "arhat.dev/dukkha/pkg/version.arch=${MATRIX_ARCH}"
  - -X "arhat.dev/dukkha/pkg/version.workspaceClean=${GIT_WORKTREE_CLEAN}"
  - -X "arhat.dev/dukkha/pkg/version.goCompilerPlatform=$(go version | cut -d\  -f4)"
  outputs@shell: |-
    suffix=""
    if [[ "${MATRIX_KERNEL}" == "windows" ]]; then
      suffix="${suffix}.exe"
    fi

    if [[ "${MATRIX_KERNEL}" == "${HOST_KERNEL}" ]] && [[ "${MATRIX_ARCH}" == "${HOST_ARCH}" ]]; then
      echo "- build/dukkha${suffix}"
    fi

    echo "- build/dukkha.${MATRIX_KERNEL}.${MATRIX_ARCH}${suffix}"
  extra_args:
  - -buildmode=default
  - -mod=vendor
  - -trimpath
