- name: dukkha
  env:
  - name: PROFILE_OUTPUT_DIR
    value: build/test-profile
  hooks:
    before:
    - shell: mkdir -p ${PROFILE_OUTPUT_DIR}
    # after:success:
    # - shell: go tool pprof ${PROFILE_OUTPUT_DIR}/mem.out
  matrix:
    pkg@env|template: |-
      {{-
        eval.Shell "go list ./pkg/..."
        | removePrefix "$(go list -m)/"
        | addPrefix "- "
      -}}

  path@env: ./${MATRIX_PKG}
  json_output_file@template: |-
      build/test-profile/result-{{ matrix.pkg | strings.KebabCase }}.json

  verbose: true
  panic_on_exit_0: true

  profile:
    output_dir@env: ${PROFILE_OUTPUT_DIR}
    coverage:
      enabled: true
      output@template: |-
        coverage.{{ matrix.pkg | strings.KebabCase }}.txt
      packages@env:
      - ./${MATRIX_PKG}

    memory:
      enabled: true
      output@template: |-
        memory.{{ matrix.pkg | strings.KebabCase }}.out

    cpu:
      enabled: true
      output@template: |-
        cpu.{{ matrix.pkg | strings.KebabCase }}.out

    mutex:
      enabled: true
      output@template: |-
        mutex.{{ matrix.pkg | strings.KebabCase }}.out

    block:
      enabled: true
      output@template: |-
        block.{{ matrix.pkg | strings.KebabCase }}.out

    trace:
      enabled: true
      output@template: |-
        trace.{{ matrix.pkg | strings.KebabCase }}.out
