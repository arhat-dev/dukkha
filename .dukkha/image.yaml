tools:
  docker:
  # first tool in this kind will be the default tool
  - name: docker
    env:
    - DOCKER_BUILDKIT=1

  buildah:
  - name: buildah
  # $ docker volume create buildah-dukkha
  - name: in-docker
    cmd:
    - |-
      docker run -it --rm \
        --workdir $(pwd) \
        -v $(pwd):$(pwd) \
        --security-opt label=disable \
        --security-opt seccomp=unconfined \
        -v buildah-dukkha:/var/lib/containers \
        --device /dev/fuse:rw \
        quay.io/buildah/stable \
        buildah

buildah:bud:
- &dukkha_image_build
  name: dukkha
  matrix@template_file: &dukkha_image_matrix cicd/image-matrix.yml
  image_names: &dukkha_image_names
  - image: ghcr.io/arhat-dev/dukkha
    manifest: ghcr.io/arhat-dev/dukkha
  dockerfile@env: cicd/docker/dukkha.${MATRIX_KERNEL}.dockerfile
  # yamllint disable-line rule:quoted-strings
  context: "."
  extra_args@template:
  - --pull
  - --no-cache
  - --build-arg="MATRIX_ARCH={{ .Env.MATRIX_ARCH }}"
  - --build-arg="MATRIX_ROOTFS={{ .Env.MATRIX_ROOTFS | default "alpine" }}"

buildah:login:
- name: ghcr
  registry: ghcr.io
  username: ${GHCR_USER}
  password@env: ${GHCR_PASS}

buildah:push:
- &dukkha_image_push
  name: dukkha
  hooks:
    before:
    - task: buildah:login:ghcr
  matrix@template_file: *dukkha_image_matrix
  image_names: *dukkha_image_names

docker:build:
- *dukkha_image_build

docker:push:
- *dukkha_image_push
