tools:
  docker:
  # first tool in this kind will be the default tool
  - name: default-docker
    env:
    - DOCKER_BUILDKIT=0

docker:build:
- name: dukkha
  matrix@template_file: scripts/get-image-build-matrix.yml
  image_names@template_file: scripts/get-image-name.yml
  dockerfile@shell_file: scripts/get-dockerfile.sh
  # yamllint disable-line rule:quoted-strings
  build_context: "."
  extraArgs@template: |-
    {{- $platform_arch := getDockerPlatformArch .Env.MATRIX_ARCH -}}
    {{- $host_platform_arch := getDockerPlatformArch .Env.HOST_ARCH -}}

    - --platform={{ .Env.MATRIX_KERNEL }}/{{ $platform_arch }}
    - --pull
    - --build-arg="ARCH={{- .Env.MATRIX_ARCH | trimSuffix "hf" -}}"
    - --build-arg="TARGET=dukkha.${MATRIX_KERNEL}.${MATRIX_ARCH}"
    - --build-arg="APP=dukkha"
    - --build-arg="PLATFORM_ARCH={{ $platform_arch }}"
    - --build-arg="HOST_PLATFORM_ARCH={{ $host_platform_arch }}"
    - --no-cache

docker:push:
- name: dukkha
  matrix@template_file: scripts/get-image-build-matrix.yml
  image_names@template_file: scripts/get-image-name.yml
